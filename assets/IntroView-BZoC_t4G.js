import{d as We,s as at,r as C,w as ot,o as rt,a as lt,c as Ve,b as X,T as Re,u as it,e as Se,f as S,g as xe,h as oe,i as f,n as ge,t as ct,j as z,F as Ee,k as Pe,l as De,U as Ae,m as ut,R as dt,p as qe,I as mt,V as ft,_ as gt}from"./index-DbTwCHOh.js";import{u as Oe,i as Ne,p as pt}from"./image_embeddings-C2wiE1-6.js";/**
 * @author Markus Ekholm
 * @copyright 2012-2023 (c) Markus Ekholm <markus at botten dot org >
 * @license Copyright (c) 2012-2023, Markus Ekholm
 * All rights reserved.
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *    * Redistributions of source code must retain the above copyright
 *      notice, this list of conditions and the following disclaimer.
 *    * Redistributions in binary form must reproduce the above copyright
 *      notice, this list of conditions and the following disclaimer in the
 *      documentation and/or other materials provided with the distribution.
 *    * Neither the name of the author nor the
 *      names of its contributors may be used to endorse or promote products
 *      derived from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL MARKUS EKHOLM BE LIABLE FOR ANY
 * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */function Ue(e,s){s=He(s||{R:255,G:255,B:255}),e=He(e);let t=e;return e.A!==void 0&&(t={R:s.R+(e.R-s.R)*e.A,G:s.G+(e.G-s.G)*e.A,B:s.B+(e.B-s.B)*e.A}),vt(ht(t))}function ht(e){let s=e.R/255,t=e.G/255,n=e.B/255;s>.04045?s=Math.pow((s+.055)/1.055,2.4):s=s/12.92,t>.04045?t=Math.pow((t+.055)/1.055,2.4):t=t/12.92,n>.04045?n=Math.pow((n+.055)/1.055,2.4):n=n/12.92,s*=100,t*=100,n*=100;const a=s*.4124+t*.3576+n*.1805,r=s*.2126+t*.7152+n*.0722,g=s*.0193+t*.1192+n*.9505;return{X:a,Y:r,Z:g}}function vt(e){let a=e.Y/100,r=e.Z/108.883,g=e.X/95.047;g>.008856?g=Math.pow(g,1/3):g=7.787*g+16/116,a>.008856?a=Math.pow(a,1/3):a=7.787*a+16/116,r>.008856?r=Math.pow(r,1/3):r=7.787*r+16/116;const G=116*a-16,E=500*(g-a),re=200*(a-r);return{L:G,a:E,b:re}}function He(e){let s,t,n,a;"R"in e?(s=e.R,t=e.G,n=e.B,a=e.A):(s=e.r,t=e.g,n=e.b,a=e.a);const r={R:s,G:t,B:n};return a!==void 0&&(r.A=a),r}/**
 * @author Markus Ekholm
 * @copyright 2012-2023 (c) Markus Ekholm <markus at botten dot org >
 * @license Copyright (c) 2012-2023, Markus Ekholm
 * All rights reserved.
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *    * Redistributions of source code must retain the above copyright
 *      notice, this list of conditions and the following disclaimer.
 *    * Redistributions in binary form must reproduce the above copyright
 *      notice, this list of conditions and the following disclaimer in the
 *      documentation and/or other materials provided with the distribution.
 *    * Neither the name of the author nor the
 *      names of its contributors may be used to endorse or promote products
 *      derived from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL MARKUS EKHOLM BE LIABLE FOR ANY
 * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */function wt(e,s,t){("R"in e||"r"in e)&&(e=Ue(e,t)),("R"in s||"r"in s)&&(s=Ue(s,t));const n=e.L,a=e.a,r=e.b,g=s.L,G=s.a,E=s.b,re=1,y=1,x=1,N=Math.sqrt(Math.pow(a,2)+Math.pow(r,2)),U=Math.sqrt(Math.pow(G,2)+Math.pow(E,2)),Y=(N+U)/2,pe=.5*(1-Math.sqrt(Math.pow(Y,7)/(Math.pow(Y,7)+Math.pow(25,7)))),_=(1+pe)*a,P=(1+pe)*G,H=Math.sqrt(Math.pow(_,2)+Math.pow(r,2)),le=Math.sqrt(Math.pow(P,2)+Math.pow(E,2)),ie=$e(r,_),k=$e(E,P),ce=g-n,Z=le-H,he=yt(N,U,ie,k),ue=2*Math.sqrt(H*le)*Math.sin(ae(he)/2),J=(n+g)/2,K=(H+le)/2,$=_t(N,U,ie,k),j=1-.17*Math.cos(ae($-30))+.24*Math.cos(ae(2*$))+.32*Math.cos(ae(3*$+6))-.2*Math.cos(ae(4*$-63)),I=30*Math.exp(-Math.pow(($-275)/25,2)),Me=Math.sqrt(Math.pow(K,7)/(Math.pow(K,7)+Math.pow(25,7))),ye=1+.015*Math.pow(J-50,2)/Math.sqrt(20+Math.pow(J-50,2)),ve=1+.045*K,we=1+.015*K*j,_e=-2*Me*Math.sin(ae(2*I));return Math.sqrt(Math.pow(ce/(ye*re),2)+Math.pow(Z/(ve*y),2)+Math.pow(ue/(we*x),2)+_e*(Z/(ve*y))*(ue/(we*x)))}function Mt(e){return e*(180/Math.PI)}function ae(e){return e*(Math.PI/180)}function $e(e,s){if(e===0&&s===0)return 0;{const t=Mt(Math.atan2(e,s));return t>=0?t:t+360}}function yt(e,s,t,n){if(e*s===0)return 0;if(Math.abs(n-t)<=180)return n-t;if(n-t>180)return n-t-360;if(n-t<-180)return n-t+360;throw new Error}function _t(e,s,t,n){if(e*s===0)return t+n;if(Math.abs(t-n)<=180)return(t+n)/2;if(Math.abs(t-n)>180&&t+n<360)return(t+n+360)/2;if(Math.abs(t-n)>180&&t+n>=360)return(t+n-360)/2;throw new Error}function je(e,s){let t=1/0;for(let n=0;n<s.length;n++){const a=wt(s[n],e);t=Math.min(a,t)}return t}function bt(e,s){const t=e.length,n=[],a=[];for(let y=0;y<t;y++){const x=e[y],N=je(x,s);n.push(N);const U=e[2],Y=je(U,e);a.push(Y)}const r=n.reduce((y,x)=>y+x),g=a.reduce((y,x)=>y+x),G=r/t,E=g/t;return(G+E)/2}function Ct(e){return e.map(s=>s/127.5-1)}function kt(e,s){if(e.length!==s.length)throw new Error("Vectors must be the same length");let t=0,n=0,a=0;for(let r=0;r<e.length;r++)t+=e[r]*s[r],n+=e[r]*e[r],a+=s[r]*s[r];return n=Math.sqrt(n),a=Math.sqrt(a),n===0||a===0?0:t/(n*a)}const It={id:"secondDirection",class:"textDirections"},Rt={key:0},St=["src","alt"],xt={key:0,style:{display:"flex","margin-top":"5px","align-items":"center"}},Et=27,Pt=We({__name:"IntroScene",setup(e){const{stream:s,camEnabled:t,searchResults:n,clusterId:a,topImage:r,finalUserPalette:g,curCamFrameEmbedding:G}=at(Oe()),{start:E,stop:re,setGestureRecognizer:y,getGestureRecognizer:x,setImageEmbedder:N,getImageEmbedder:U,setImageSegmenter:Y,getImageSegmenter:pe}=Oe();console.log(t.value," intro store ");const _=C(null),P=C(null),H=C(null);C({});const le=it(),ie=C({}),k=C([]),ce=C("ENABLE WEBCAM"),Z=C(!1);let he=0,ue=-1;const J=C(!1),K=C(!1),$=C(!1);let j=null;const I=C(!1);ot(Z,l=>{l&&setTimeout(()=>{le.push("/selection")},300)}),rt(()=>{console.log("IntroScene mounted")}),lt(()=>{be()});const Me=async()=>{const l=await Ae.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"),i=await qe.createFromOptions(l,{baseOptions:{modelAssetPath:"https://storage.googleapis.com/mediapipe-models/gesture_recognizer/gesture_recognizer/float16/1/gesture_recognizer.task",delegate:"GPU"},runningMode:"VIDEO"});y(i)},ye=async()=>{const l=await Ae.forVisionTasks("node_modules/@mediapipe/tasks-vision/wasm"),i=await ut.createFromOptions(l,{baseOptions:{modelAssetPath:"https://storage.googleapis.com/mediapipe-models/image_embedder/mobilenet_v3_large/float32/1/mobilenet_v3_large.tflite",delegate:"GPU"},runningMode:"IMAGE",quantize:!1,l2Normalize:!0});N(i)},ve=async()=>{const l=await Ae.forVisionTasks("node_modules/@mediapipe/tasks-vision/wasm"),i=await dt.createFromOptions(l,{baseOptions:{modelAssetPath:"https://storage.googleapis.com/mediapipe-models/image_segmenter/selfie_multiclass_256x256/float32/latest/selfie_multiclass_256x256.tflite",delegate:"GPU"},runningMode:"VIDEO",outputCategoryMask:!0});Y(i)},we=async()=>{t.value?(be(),j!==null&&cancelAnimationFrame(j)):(await ye(),await ve(),await Me(),await _e())},_e=async()=>{if(!(!_.value||!P.value))try{s.value=await E(),_.value.srcObject=s.value,t.value=!0,ce.value="DISABLE WEBCAM",_.value.addEventListener("loadedmetadata",()=>{var l;Te(),(l=_.value)==null||l.play(),j!==null&&cancelAnimationFrame(j),Fe()})}catch(l){console.error("Webcam error:",l)}},be=()=>{var l;(l=s.value)==null||l.getTracks().forEach(i=>i.stop()),s.value=null,t.value=!1,ce.value="ENABLE WEBCAM"},Xe=async()=>{const l=pe(),i=x(),Q=U();if(!t.value||!_.value||!P.value||!H.value||!l)return;const B=_.value,ee=P.value,M=H.value,R=ee.getContext("2d",{willReadFrequently:!0});if(M.getContext("2d",{willReadFrequently:!0}),!!R)try{const D=await l.segmentForVideo(B,performance.now()),de=D.categoryMask.getAsUint8Array(),{width:Ce,height:ke}=D.categoryMask;D.categoryMask.close();const Ze=function(){R.drawImage(B,0,0,ee.width,ee.height);const c=R.getImageData(0,0,Ce,ke),m=c.data,u=new Set(de);K.value=u.has(4);const te=[[0,0,0,50],[255,0,0,100],[0,255,0,100],[0,0,255,100]],V=[],A=[],se=4;for(let o=0;o<de.length;o++){const d=de[o];V.push(d);const h=te[d]||[255,255,255,100],v=o*4;d==se||(m[v]=255,m[v+1]=255,m[v+2]=255,m[v+3]=255)}const b=c.width,p=c.height,F=b*4;for(let o=0;o<p;o++){const d=o*F;let h=0,v=b-1;for(;h<v;){const T=d+h*4,q=d+v*4;for(let w=0;w<4;w++){const L=m[T+w];m[T+w]=m[q+w],m[q+w]=L}h++,v--}}R.putImageData(c,0,0),R.save()},Je=function(c,m=["Victory","Open_Palm"]){var b,p,F;let u=null;const te=Date.now();c.setTransform(-1,0,0,1,ee.width,0);const V=function(o,d){const h={Victory:{displayStr:"✌️",landmarkIndex:13},Open_Palm:{displayStr:"✋",landmarkIndex:17}},v=h[d].displayStr??"❓",T=h[d].landmarkIndex??"❓";for(const q of o.landmarks)q.forEach((w,L)=>{const me=w.x*c.canvas.width,ne=w.y*c.canvas.height;c.font="16px sans-serif",c.fillStyle="black",L==T&&(c.font="120px sans-serif",c.fillText(v,me-10,ne+10))})},A=function(o,d){for(const h of o.landmarks)console.log("doing this stuff"),d.drawConnectors(h,qe.HAND_CONNECTIONS,{color:"#000000",lineWidth:1}),d.drawLandmarks(h,{color:"#000000",lineWidth:.5})};B.currentTime!==ue&&(ue=B.currentTime,u=i.recognizeForVideo(B,te));const se=new mt(c);if((u==null?void 0:u.landmarks)!=null){const o=((F=(p=(b=u==null?void 0:u.gestures)==null?void 0:b[0])==null?void 0:p[0])==null?void 0:F.categoryName)??null;return m.includes(o)?(console.log(u.landmarks,"well its not null"),V(u,o)):(J.value&&I.value&&(Z.value=!0),A(u,se)),I.value=m.includes(o),o}return c.setTransform(1,0,0,1,0,0),null},Ke=async function(c){const m=c.getImageData(0,0,Ce,ke),u=document.createElement("canvas");u.width=m.width,u.height=m.height,u.getContext("2d",{willReadFrequently:!0}).putImageData(m,0,0);const V=u.toDataURL(),A=new Image;A.src=V,A.style.width="512px",A.style.margin="10px";const b=await new ft(V).getPalette();return Object.values(b).filter(o=>o).sort((o,d)=>d._population-o._population).slice(0,5).reduce((o,d)=>{const h=d._rgb;return o.push(h),o},[])};Ze();const Qe=i?Je(R,["Victory","Open_Palm"]):null,[Ie,et]=Ye(0,he);if(Ie&&(he=et),(!k.value.values||k.value.values.length===0)&&Ie){const c=await Ke(R);k.value=c}const tt=R.getImageData(0,0,Ce,ke),Le=await Q.embed(tt),st=Le.embeddings[0].floatEmbedding;G.value=Le;const nt=Object.keys(Ne);if(Ie&&I.value){const c=[];let m=0,u=0;const te=new Set;nt.forEach(p=>{var v;const F=p.split("_").slice(-1)[0][0],o=p.split("_")[1];if(te.add(o),["tops"].includes(o)&&Number(F)==0&&k.value.length>0){const T=Ct(Ne[p]),q=kt(st,T),w=((v=pt[p])==null?void 0:v.palette)??null,L=JSON.parse(w),me=w==null?null:L.map(([W,O,fe])=>({r:Math.round(W*255),g:Math.round(O*255),b:Math.round(fe*255)})),ne=k.value.length===0?null:k.value.map(([W,O,fe])=>({r:W,g:O,b:fe})),ze=ne&&me?bt(ne,me):null;w==null?m+=1:u+=1,c.push({key:p,similarityCosine:q,similarityColor:ze,palette:L})}});const V=function(p,F,o,d,h){const v=p.filter(W=>W.similarityColor!=null),T=h==="Victory",q=F==="cosine"?"similarityCosine":"similarityColor",w=o==="cosine"?"similarityCosine":"similarityColor",L=(W,O,fe)=>W.slice().sort((Ge,Be)=>fe?Ge[O]-Be[O]:Be[O]-Ge[O]),ne=L(v,q,T).slice(0,d);return L(ne,w,T)},A="cosine",se=A=="cosine"?"color":"cosine";let b=V(c,A,se,30,Qe);n.value.push(b),n.value.length>Et&&(J.value=!0,g.value=k.value,n.value.pop()),b=b.map(p=>({...p,width:300})),ie.value=b}(!I.value&&!J.value||n.value.length>100)&&(n.value=[])}catch(D){console.warn("interactionLoop() failed: ",D)}},Fe=()=>{Te(),Xe(),j=requestAnimationFrame(Fe)},Te=()=>{if(!_.value||!P.value)return;const l=_.value,i=P.value;i.width=l.videoWidth,i.height=l.videoHeight};function Ye(l,i){const Q=performance.now();return Q-i>=l?[!0,Q]:[!1,i]}return(l,i)=>{const Q=Se("v-col"),B=Se("v-row"),ee=Se("v-container");return S(),Ve(Re,{name:"fadeEaseOut"},{default:X(()=>[Z.value?xe("",!0):(S(),Ve(ee,{key:0,fluid:"",id:"containerDiv",class:"App"},{default:X(()=>[oe(B,{class:"pad-bot-2"},{default:X(()=>[oe(Q,{id:"titleDiv",md:5,lg:6,class:ge({"alpha-05":I.value})},{default:X(()=>i[0]||(i[0]=[f("h1",{class:"titleText"},"Real-time Similarity Search via Image Segmentation and Encoding",-1),f("br",null,null,-1)])),_:1,__:[0]},8,["class"])]),_:1}),f("button",{onClick:we},ct(ce.value),1),oe(B,{id:"webcamRow"},{default:X(()=>[f("div",null,[oe(Re,{name:"fade"},{default:X(()=>[f("span",{id:"firstDirection",class:ge(["textDirections",{"alpha-05":I.value}])},i[1]||(i[1]=[f("h1",null,"Search Archive Store",-1),f("p",{style:{"font-size":"2rem"}}," Center yourself in frame and do this '✌️' ",-1)]),2)]),_:1}),f("span",It,[oe(Re,{name:"fade",style:{"font-size":"1.5rem"}},{default:X(()=>[$.value?(S(),z("p",Rt,"Hold that pose...")):xe("",!0)]),_:1})])]),f("div",{class:ge(["webcam-container",{"scale-15":I.value}])},[f("video",{ref_key:"videoRef",ref:_,autoplay:"",muted:"",playsinline:"",style:{transform:"scaleX(-1)",opacity:"1"}},null,512),f("canvas",{ref_key:"canvasRef",ref:P},null,512),f("canvas",{ref_key:"maskCanvasRef",ref:H},null,512)],2)]),_:1}),f("div",{id:"userPaletteRow",class:ge(["palette-row",{"alpha-05":I.value}])},[(S(!0),z(Ee,null,Pe(k.value,(M,R)=>(S(),z("div",{key:R,class:"color-block",style:De({backgroundColor:`rgb(${M[0]}, ${M[1]}, ${M[2]})`})},null,4))),128))],2),i[2]||(i[2]=f("canvas",{id:"threeCanvas"},null,-1)),f("div",{id:"photoDiv",class:ge({"scale-1":I.value})},[(S(!0),z(Ee,null,Pe(ie.value,(M,R)=>(S(),z("div",{key:M.key,class:"fade-item",style:{margin:"5px"}},[f("img",{src:`/src/assets/images/${M.key}`,alt:M.key,style:De({width:`${M.width}px`})},null,12,St),M.palette&&Array.isArray(M.palette)?(S(),z("div",xt,[(S(!0),z(Ee,null,Pe(M.palette,(D,de)=>(S(),z("div",{key:de,style:De({width:"15px",height:"15px",backgroundColor:`rgb(${D[0]*255}, ${D[1]*255}, ${D[2]*255})`,border:"1px solid #000",marginRight:"4px"})},null,4))),128))])):xe("",!0)]))),128))],2)]),_:1,__:[2]}))]),_:1})}}}),Dt=gt(Pt,[["__scopeId","data-v-c862f2d6"]]),Tt=We({__name:"IntroView",setup(e){return(s,t)=>(S(),z("main",null,[oe(Dt)]))}});export{Tt as default};
